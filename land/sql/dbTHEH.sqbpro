<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="dbTHEH.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="4483"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="real_estate" custom_title="0" dock_id="4" table="4,11:mainreal_estate"/><dock_state state="000000ff00000000fd0000000100000002000005a700000392fc0100000002fb000000160064006f0063006b00420072006f00770073006500310100000000000005a70000000000000000fb000000160064006f0063006b00420072006f00770073006500340100000000ffffffff0000015300ffffff000005a70000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings/></tab_browse><tab_sql><sql name="SQL 1* (1)">select *
from tblReal;

commit;



where 계약년도 in ('2018','2019');



select case when 해제사유발생일 is not NULL
            then date(printf('20%02d-%02d-%02d',substr(해제사유발생일,1,2), substr(해제사유발생일,4,2) , substr(해제사유발생일,7,2))) 
			else NULL
			end
FROM real_estate
where 해제여부 = &quot;O&quot; ;




--CREATE TABLE real_estate_unique AS
select * --CAST(replace(거래금액,&quot;,&quot;,&quot;&quot;) as integer)
FROM real_estate;

       , ROW_NUMBER() OVER (
           PARTITION BY 법정동시군구코드, 계약년도, 계약월, 계약일, 단지일련번호, 아파트동명, 층, 전용면적,  해제여부
           ORDER BY 계약일 -- 또는 다른 정렬 기준
       ) AS no

insert into tblReal


SELECT 법정동시군구코드   sggCd, DATE(printf('%04d-%02d-%02d', 계약년도, 계약월, 계약일))  dealDate,  단지일련번호 aptSeq, 층 floor, 전용면적 excluUseAr 
       ,CASE WHEN 해제여부 = 'O' THEN -1 ELSE 1 END  cdealType
       , ROW_NUMBER() OVER (
           PARTITION BY 법정동시군구코드, 계약년도, 계약월, 계약일, 단지일련번호, 층, 전용면적, 해제여부
           ORDER BY 계약일 -- 또는 다른 정렬 기준
       ) AS no
	   , round( 전용면적 / 3.305785,1 ) useArea
	   , case when 해제사유발생일 is not NULL
             then date(printf('20%02d-%02d-%02d',substr(해제사유발생일,1,2), substr(해제사유발생일,4,2) , substr(해제사유발생일,7,2))) 
			 else NULL
			 end  cdealDay
	   , 법정동 umdNm, 지번 jibun, 단지명 aptNm, 아파트동명 aptDong  
	   , case when 해제사유발생일 is not NULL
             then date(printf('20%02d-%02d-%02d',substr(등기일자,1,2), substr(등기일자,4,2) , substr(등기일자,7,2))) 
			 else NULL
			 end  rgstDate
	   , CAST(replace(거래금액,&quot;,&quot;,&quot;&quot;) as integer) dealAmount, 거래유형 dealingGbn, 중개사소재지 estateAgentSggNm
	   , 매도자 slerGbn, 매수자 buyerGbn, 토지임대부아파트여부 landLeaseholdGbn
	   , 법정동읍면동코드 umdCd, 법정동지번코드 landCd, 법정동본번코드 bonbun, 법정동부번코드 bubun
	   , 도로명 roadNm, 도로명시군구코드 roadNmSggCd, 도로명코드 roadNmCd
	   , 도로명일련번호코드 roadNmSeq, 도로명지상지하코드 roadNmbCd, 도로명건물본번호코드 roadNmBonbun
FROM real_estate;




/*
WITH ranked AS (
    SELECT *,
           ROW_NUMBER() OVER (
               PARTITION BY 법정동시군구코드, 단지일련번호, 계약년도, 계약월, 계약일
               ORDER BY 계약금액 DESC
           ) AS rn
    FROM real_estate
)
SELECT *
FROM ranked
WHERE rn = 1;
*/


update tblReal
  set cdealType = case cdealType when -1 then -1 else 1 end;
  
  
select cdealType
from tblReal;



</sql><sql name="SQL 4">CREATE TABLE &quot;tblReal&quot; (
	&quot;sggCd&quot;	TEXT,
	&quot;dealDate&quot;	date,
	&quot;aptSeq&quot;	TEXT,
	&quot;floor&quot; 	 integer,
	&quot;excluUseAr&quot;	 real,
	&quot;cdealType&quot;	integer,
	&quot;no&quot;	integer,
	&quot;cdealDay&quot;	date,
	&quot;umdNm&quot;	TEXT,
	&quot;jibun&quot;	TEXT,
	&quot;aptNm&quot;	TEXT,
	&quot;aptDong&quot;	TEXT,
	&quot;rgstDate&quot;	TEXT,
	&quot;dealAmount&quot;	real,
	&quot;dealingGbn&quot;	TEXT,
	&quot;estateAgentSggNm&quot;	TEXT,
	&quot;slerGbn&quot;	TEXT,
	&quot;buyerGbn&quot;	TEXT,
	&quot;landLeaseholdGbn&quot;	TEXT,
	&quot;umdCd&quot;	TEXT,
	&quot;landCd&quot;	TEXT,
	&quot;bonbun&quot;	TEXT,
	&quot;bubun&quot;	TEXT,
	&quot;roadNm&quot;	TEXT,
	&quot;roadNmSggCd&quot;	TEXT,
	&quot;roadNmCd&quot;	TEXT,
	&quot;roadNmSeq&quot;	TEXT,
	&quot;roadNmbCd&quot;	TEXT,
	&quot;roadNmBonbun&quot;	TEXT
);

</sql><sql name="SQL 4* (1)*">-- 서울시 구별 아파트별 평균을 구한 후 구별 평균을 구함


select RANK() OVER (ORDER BY round(avg(dealAvgAmount),0) DESC) AS rank
      , p1_code, nm1, sggCd, dealYear, nm2, avg(dealAvgAmount) dealAvgAmount
from(
select c1.p1_code, c2.nm nm1, r.sggCd, strftime('%Y',dealDate) dealYear, c1.nm nm2
      , r.aptSeq, r.aptNm 
	  , round(avg(cdealType*dealAmount/excluUseAr * 10000),0) dealAvgAmount, count(*) cnt
from tblReal r left join tblCode c1
					on r.sggCd = c1.code
	           left join tblCode c2
					on c1.p1_code = c2.code
where c1.p1_code ='11000' -- 서울
--  and r.dealDate between '2024-01-01' and '2024-12-31'
group by c1.p1_code, c2.nm, r.sggCd, strftime('%Y',dealDate), c1.nm, r.aptSeq, r.aptNm 
) 
group by p1_code, nm1, sggCd, dealYear, nm2
order by dealYear DESC, round(avg(dealAvgAmount),0) desc ;


--- 피벗 형식

SELECT
    c1.p1_code,
    c2.nm AS nm1,
    r.sggCd,
    c1.nm AS nm2,
    ROUND(AVG(CASE WHEN strftime('%Y', r.dealDate) = '2023' THEN cdealType * dealAmount / excluUseAr * 10000 END), 0) AS &quot;2023&quot;,
    ROUND(AVG(CASE WHEN strftime('%Y', r.dealDate) = '2024' THEN cdealType * dealAmount / excluUseAr * 10000 END), 0) AS &quot;2024&quot;,
    ROUND(AVG(CASE WHEN strftime('%Y', r.dealDate) = '2025' THEN cdealType * dealAmount / excluUseAr * 10000 END), 0) AS &quot;2025&quot;
FROM tblReal r
LEFT JOIN tblCode c1 ON r.sggCd = c1.code
LEFT JOIN tblCode c2 ON c1.p1_code = c2.code
WHERE c1.p1_code = '11000'  -- 서울
GROUP BY 
    c1.p1_code, c2.nm, r.sggCd, c1.nm
ORDER BY &quot;2024&quot; DESC;





--서울시 구별로 평균
select  RANK() OVER (ORDER BY strftime('%Y',dealDate) desc , round(avg(cdealType*dealAmount/excluUseAr),0) DESC) AS rank
        , c1.p1_code, c2.nm nm1, r.sggCd, strftime('%Y',dealDate) dealDate, c1.nm nm2, avg(round(cdealType*dealAmount/excluUseAr,0)) dealAvgAmount, count(*) cnt
from tblReal r left join tblCode c1
					on r.sggCd = c1.code
	           left join tblCode c2
					on c1.p1_code = c2.code
where c1.p1_code ='11000' -- 서울
--  and r.dealDate between '2024-01-01' and '2024-12-31'
group by c1.p1_code, c2.nm, r.sggCd, strftime('%Y',dealDate), c1.nm 
order by strftime('%Y',dealDate)  desc , round(avg(cdealType*dealAmount/excluUseAr),0) DESC;


select *
from tblReal r
where r.sggCd = '28237'
and r.dealDate between '2021-01-01' and '2021-12-31';



and   r.dealDate = '2016-01-10';

	
select cdealType*dealAmount
from tblReal r left join tblCode c
     on r.sggCd = c.code
	 and p1_code ='11000' -- 서울;

	
select *
from tblCode c
where c.code ='28237';	 





select strftime('%Y', dealDate) delYear,  printf('%.0f', avg(dealAmount) * 10000) dealAmount
from tblReal
where aptSeq = '11260-3783'
and excluUseAr between 84 and 85
group by strftime('%Y', dealDate);


where aptNm like '%편한세상화랑대%';


select strftime('%Y', dealDate)
       ,printf('%.0f', avg(dealAmount * cdealType))
from tblReal
where aptSeq = '11260-3783'
and excluUseAr between 84 and 85
--and cdealType = 1
group by strftime('%Y', dealDate);


select *
from tblReal;
</sql><current_tab id="2"/></tab_sql></sqlb_project>
